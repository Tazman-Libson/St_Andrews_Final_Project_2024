##Note:
Need to run all the code in the following files in order:

Data_Wrangling
MVN_support_functions
MVN_ML_Model_Fitting
MVN_Forward_and_Backward
MVN_Conditional
MVN_Gen_Sample



## Introduction
Hidden Markov Models are a very versatile generative way to model
discrete time/space data. One of the many ways they can be used is
modelling returns in finance. One of the main state dependant
distributions for these purposes is the multivariate gaussian
distribution. This allows different stocks to have an impact on
each other's variance, which is what one would naturally expect for
stocks in related fields. This paper has code for fitting multivariate
gaussian HMMs to financial data. This is taken from the Zucchini et al
(2016) textbook for fitting models using direct liklihood maximization.
The code for fitting a model is then verified by generating data from a
fitted model, then fitting another model to the generated dataset. For
further model verification, normal pseudoresiduals, as described by
Zucchini et al are used. There have been some issues which will be
described later.
## HMM basics

An m-state HMM is made up of 3 components, an m x m transition probability matrix $\Gamma$ (TPM), an initial state distribution $\delta$, and state dependent distributions. In a financial context, the relevant data is a time series taken at equally spaced intervals. Each time is considered to have a state, and for each state there is a state-dependent distribution from which the observed quantity comes. It is assumed there is no way to observe the states, hence the name Hidden Markov.

The likelihood of a set of observations for a given model can be caluclated through recursive matrix multiplation as described by Zucchini and MacDonald.

\${L_T=\delta P(x_1) \Gamma P(x_2) ... \Gamma P(x_T)1'} \$

This equation will be used for model fitting.

## Model Fitting

### Method

Model fitting is done through the `nlm` function. In order to use this, the parameters need to be unrestricted. This is done through different transformations. The required parameters are the transition probability matrix, the initial distribution, and the means and covariance matrix for each state dependent multivariate Gaussian. No transformation is needed for the means, since they are already unrestricted real values. The variance covariance matrix needs to be symmetric so only the upper triangular matrix (including the main diagonal of variances) needs to be estimated. The covariance matrix values are also non-negative. To map them onto the real numbers, the log is taken to map it to the real numbers to produce the working parameter. The transformations for the TPM and initial distributions are both identical to methods laid out by Zucchini and MacDonald.

In order to avoid underflow, the process of standardizing the probabilities and summing the log of the standardization factors is used, again as described by Zucchini and MacDonald.



###Results

## Pseudoresiduals

Pseudoresiduals are a method of checking a model. If the observations are transformed by the cumulative distribution determined by the fitted model, if the model is valid one would expect these to be Uniform Distributed. The cumulative distribution function is the conditional density function of an observation conditioned on every other observation.

\$P(X_t=x \| X^{-t}=x^{-t}) = \frac{\alpha_{t-1} \Gamma P(x) \beta_t}{\alpha_{t-1} \Gamma \beta_t} 1' \$ (Formula for Conditional Cumulative Distribution Function)

For the purpose of outlier detection, one can then take the inverse standard normal function, `qnorm`. These values are called normal pseudoresiduals. This method is laid out by Zucchini and MacDonald.

This is where problems start to arise. Essentially, for both the model fitted to the real world data, and the model fitted to the generated data, the pseudoresiduals are roughly \$ \~ N(-1, 1)\$ distributed, instead of $N(0,1)$ distributed.

```{r}
#gen_mod is model from generated data
#nlm_mod is model fitted to real world data

#mvn.cdf gives cdf values for all observered values

#histogram and qqnorm of nlm_mod:
nlm_resids <- mvn.cdf(tmatrix, nlm_mod) #tmatrix is matrix of returns for 100 days
hist(qnorm(nlm_resids),main = 'Histogram of Normal Pseudoresids of nlm_mod')
print("Variance:")
print(var(qnorm(nlm_resids)))
```

```{r}
qqnorm(qnorm(nlm_resids))
qqline(qnorm(nlm_resids))
```

```{r}

gen_resids <- mvn.cdf(nlm_gen_sample, gen_mod)
hist(qnorm(gen_resids),main = 'Histogram of Normal Pseudoresids of gen_mod')

print("Variance:")
print(var(qnorm(gen_resids)))
```

```{r}
qqnorm(qnorm(gen_resids))
qqline(qnorm(gen_resids))
```

The pseudoresidual problem remains. There was an initial problem in fitting the


